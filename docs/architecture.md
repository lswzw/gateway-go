# 网关架构设计

## 概述

这是一个基于 Go 语言开发的高性能 API 网关，采用模块化设计，支持插件化扩展。网关提供了路由转发、负载均衡、限流、熔断、认证、监控等核心功能。

## 核心特性

- **高性能**：基于 Gin 框架，支持高并发处理
- **插件化**：支持动态插件加载和管理
- **配置化**：支持 YAML 配置文件，支持热更新
- **监控完善**：集成 Prometheus 监控和分布式追踪
- **高可用**：支持熔断、重试、降级等容错机制

## 架构组件

### 1. 配置中心 (internal/config/)

配置中心负责管理网关的所有配置信息：

#### ConfigCenter
- **版本管理**：支持配置版本历史，最多保留指定数量的版本
- **热更新**：支持配置文件的实时监控和热更新
- **配置验证**：提供配置格式和内容的验证
- **回滚支持**：支持配置版本回滚

#### 配置结构
```yaml
server:
  port: 8080
  mode: debug
  read_timeout: "60s"
  write_timeout: "60s"

middleware:
  logger:
    enabled: true

plugins:
  global:
    - name: auth
      enabled: true
      order: 1
    - name: rate_limit
      enabled: true
      order: 2
    - name: circuit_breaker
      enabled: true
      order: 3

routes:
  - name: api-service
    match:
      type: prefix
      path: /api
    target:
      url: http://backend:8080
      timeout: 30000
      retries: 3
    plugins: ["auth", "rate_limit", "circuit_breaker"]
```

### 2. 路由管理器 (internal/router/)

路由管理器负责请求的路由匹配和转发：

#### Manager
- **多匹配模式**：支持精确匹配、前缀匹配、正则匹配、通配符匹配
- **优先级排序**：支持路由优先级配置
- **A/B 测试**：支持基于权重的 A/B 测试
- **动态更新**：支持路由配置的动态更新

#### 路由匹配类型
- `exact`：精确匹配路径
- `prefix`：前缀匹配
- `regex`：正则表达式匹配
- `wildcard`：通配符匹配

### 3. 插件系统 (internal/plugin/)

插件系统提供可扩展的中间件功能：

#### 插件类型
- **认证插件 (auth)**：提供身份验证和授权
- **限流插件 (rate_limit)**：提供请求限流功能
- **熔断器插件 (circuit_breaker)**：提供熔断保护
- **跨域插件 (cors)**：处理跨域请求
- **日志插件 (logger)**：记录请求日志
- **错误处理插件 (error)**：统一错误处理
- **IP白名单插件 (ipwhitelist)**：IP访问控制
- **一致性校验插件 (consistency)**：数据一致性校验

#### 插件特性
- **可插拔**：支持动态启用/禁用
- **可配置**：支持灵活的配置选项
- **可扩展**：支持自定义插件开发
- **链式执行**：支持插件链式调用

### 4. 中间件系统 (internal/middleware/)

中间件系统提供了基础设施功能，专注于请求处理的基础设施：

#### Factory
- **中间件创建**：根据配置创建相应的中间件
- **链式处理**：支持中间件的链式处理
- **条件启用**：支持中间件的条件启用

#### 内置中间件
- **日志中间件**：请求日志记录
- **错误处理中间件**：统一错误处理

**注意**：限流和熔断器功能已迁移到插件系统中，中间件系统专注于基础设施功能。

### 5. 错误处理 (internal/errors/)

错误处理系统提供了统一的错误管理：

#### 错误类型
- **GatewayError**：网关内部错误
- **UpstreamError**：上游服务错误
- **PluginError**：插件执行错误

#### 错误码
- 400：Bad Request
- 401：Unauthorized
- 403：Forbidden
- 404：Not Found
- 408：Request Timeout
- 429：Too Many Requests
- 500：Internal Server Error
- 502：Bad Gateway
- 503：Service Unavailable

### 6. 路由系统 (internal/router/)

路由系统负责请求路由和转发：

#### 路由匹配
- **精确匹配**：完全匹配路径
- **前缀匹配**：匹配路径前缀
- **正则匹配**：支持正则表达式匹配
- **优先级**：支持路由优先级设置

#### 负载均衡
- **轮询**：Round Robin 负载均衡
- **权重**：基于权重的负载均衡
- **最少连接**：Least Connection 负载均衡
- **IP哈希**：基于IP的哈希负载均衡

## 数据流

### 请求处理流程

1. **请求接收**：HTTP 服务器接收客户端请求
2. **中间件处理**：依次执行全局中间件（日志、错误处理等）
3. **路由匹配**：路由管理器根据配置匹配目标服务
4. **插件执行**：执行全局插件链和路由级插件链
5. **请求转发**：将请求转发到目标上游服务
6. **响应处理**：处理上游服务响应并返回给客户端

### 配置更新流程

1. **配置变更**：通过 API 或文件变更触发配置更新
2. **配置验证**：验证新配置的格式和内容
3. **版本管理**：创建新的配置版本
4. **热更新**：更新运行时配置
5. **路由重载**：重新加载路由配置
6. **通知机制**：通知相关组件配置变更

## 扩展性设计

### 插件扩展
- 实现 `core.Plugin` 接口
- 注册到插件管理器
- 支持配置化启用

### 中间件扩展
- 实现 Gin 中间件接口
- 通过工厂模式创建
- 支持链式组合

### 路由扩展
- 支持自定义匹配规则
- 支持自定义转发策略
- 支持负载均衡算法

## 性能特性

- **高并发**：基于 Gin 框架的高性能 HTTP 处理
- **低延迟**：优化的路由匹配算法
- **内存效率**：合理的对象池和缓存策略
- **可扩展**：支持水平扩展和负载均衡

## 可靠性特性

- **熔断保护**：防止上游服务故障影响整体
- **限流控制**：防止系统过载
- **错误恢复**：支持自动重试和降级
- **监控告警**：全面的监控和告警机制

## 架构优势

### 1. 统一性
- **插件统一**：所有业务逻辑功能都通过插件系统实现
- **配置统一**：统一的配置格式和管理方式
- **接口统一**：统一的插件接口和生命周期管理

### 2. 灵活性
- **动态配置**：支持运行时配置更新
- **插件组合**：支持插件的自由组合和排序
- **路由级控制**：支持按路由级别配置插件

### 3. 可维护性
- **模块化设计**：清晰的模块边界和职责分离
- **代码复用**：避免功能重复实现
- **测试友好**：统一的测试框架和接口

### 4. 可扩展性
- **插件生态**：丰富的内置插件和扩展机制
- **水平扩展**：支持多实例部署和负载均衡
- **功能扩展**：支持新功能的快速集成 