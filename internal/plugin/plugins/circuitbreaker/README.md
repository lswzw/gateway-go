# 熔断器插件（circuit_breaker）

## 一、概述
熔断器插件用于防止后端服务故障影响整体系统，通过监控请求失败率自动切换服务状态，提升系统稳定性。

## 二、设计目标
1. 自动检测服务异常并熔断
2. 支持多种熔断状态（关闭、开启、半开）
3. 灵活配置阈值和窗口
4. 自动恢复与统计
5. 完善的错误处理和日志记录

## 三、流程图
1. 客户端发起请求
2. 插件拦截请求
3. 获取目标服务熔断器
4. 判断熔断器状态
   - 关闭：正常请求
   - 开启：直接拒绝
   - 半开：允许部分请求
5. 根据请求结果更新熔断器状态

## 四、配置参数

| 名称                | 数据类型         | 必填 | 默认值         | 描述                         |
|---------------------|----------------|------|----------------|------------------------------|
| failure_threshold   | int            | 否   | 5              | 失败阈值                      |
| recovery_timeout    | int            | 否   | 30             | 恢复超时（秒）                |
| half_open_quota     | int            | 否   | 2              | 半开状态最大请求数            |
| success_threshold   | int            | 否   | 3              | 半开状态成功阈值              |
| window_size         | int            | 否   | 10             | 统计窗口大小（秒）            |
| error_codes         | array of int   | 否   | [500,502,503]  | 熔断错误状态码                |

## 五、配置示例

```yaml
- name: circuit_breaker
  enabled: true
  order: 4
  config:
    failure_threshold: 5
    recovery_timeout: 60
    half_open_quota: 3
    error_codes: [500, 502, 503, 504]
    success_threshold: 2
    window_size: 60
```

## 六、运行属性
- 插件执行阶段：流量控制阶段
- 插件执行优先级：4

## 七、请求示例
```bash
curl http://localhost:8080/api/service
```

## 八、处理流程
1. 校验配置参数
2. 获取目标服务熔断器
3. 判断熔断器状态
4. 根据请求结果更新熔断器状态
5. 状态切换自动完成

## 九、错误码

| HTTP 状态码 | 出错信息           | 说明                   |
|-------------|--------------------|------------------------|
| 503         | 服务暂时不可用     | 熔断器开启，拒绝请求   |

## 十、插件配置
在路由或全局plugins中添加`circuit_breaker`插件即可。 